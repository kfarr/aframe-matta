<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>A-Frame Matta</title>
    <meta name="description" content="A-Frame Matta">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css">

    <script src="https://aframe.io/releases/0.7.0/aframe.min.js"></script>
    <!-- <script src="https://rawgit.com/aframevr/aframe/master/dist/aframe-master.js"></script> -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.min.js"></script>
    <script src="/easyrtc/easyrtc.js"></script>
    <!-- <script src="/build.js"></script> -->
    <script>window.NAF || document.write('<script src="https://unpkg.com/networked-aframe/dist/networked-aframe.min.js">\x3C/script>')</script>

    <script src="https://rawgit.com/dbradleyfl/aframe-gridhelper/master/dist/aframe-gridhelper-component.min.js"></script>
    <script src="https://unpkg.com/aframe-randomizer-components@^3.0.1/dist/aframe-randomizer-components.min.js"></script>
    <script src="https://unpkg.com/aframe-particle-system-component@1.0.5/dist/aframe-particle-system-component.min.js"></script>
    <!-- <script src="/js/spawn-in-circle.component.js"></script> -->

    <!-- <script  src="https://rawgit.com/fernandojsg/aframe-input-mapping-component/master/dist/aframe-input-mapping-component.min.js"></script> -->


    <style>
        .wizard {
          z-index: 5;
          border-radius: 10px;
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translateX(-50%) translateY(-50%);
          padding: 1.5em;
          color: #FFF;
          background: rgba(0, 0, 0, 0.75);
          font-family: Source Sans Pro, Helvetica Neue, Helvetica, Arial, sans-serif;
        }
    </style>

  </head>

  <script>

  // 'vive-controls': {
  //   triggerdown: 'placeObject'
  // },

  // var mappings = {
  //   default: {
  //     'vive-controls': {
  //       triggerdown: 'placeObject'
  //     },
  //   }
  // };
  //
  // AFRAME.registerInputMappings(mappings);
  AFRAME.registerComponent('spawn-projector', {
    schema: {
      projectorTemplate: {default: '#projector-template'},
      projectorClass: {default: '#projector1'},
    },

    init: function() {
    },

    play: function () {
      this.el.addEventListener('triggerdown', this.placeObject.bind(this));
      console.log("play");
    },

    pause: function () {
      this.el.removeEventListener('triggerdown', this.placeObject);
    },

    remove: function () {
      this.el.removeEventListener('triggerdown', this.placeObject);
    },

    placeObject: function() {
      console.log("create");
      var el = document.createElement('a-entity');
      el.setAttribute('networked', 'template:' + this.data.projectorTemplate);
      // el.setAttribute('remove-in-seconds', 3);
      // el.setAttribute('forward', 'speed:0.3');

      var thisEl = document.getElementById("projector-preview");
      el.setAttribute('position', this.getInitialPosition(thisEl));

      var worldQuaternion = new THREE.Quaternion();
      thisEl.object3D.getWorldQuaternion(worldQuaternion);
      console.log(worldQuaternion);

      el.object3D.applyQuaternion(worldQuaternion);
      var scene = document.querySelector('a-scene');
      scene.appendChild(el);
    },

    getInitialPosition: function(spawnerEl) {
      var worldPos = new THREE.Vector3();
      worldPos.setFromMatrixPosition(spawnerEl.object3D.matrixWorld);
      return worldPos;
    },
  });
  </script>

  <body>
    <a-scene gridhelper="size: 5; divisions: 50; colorGrid: fuchsia" networked-scene="
      room: handcontrollers;
      debug: true;
    ">
      <a-assets>

        <img id="grid" src="https://img.gs/bbdkhfbzkk/stretch/https://i.imgur.com/25P1geh.png" crossorigin="anonymous">
        <img id="sky" src="http://i.imgur.com/WqlqEkq.jpg" crossorigin="anonymous" />

        <!-- Templates -->

        <!-- Player -->
        <template id="player-template">
          <a-entity></a-entity>
        </template>

        <!-- Head -->
        <template id="head-template">
          <a-entity class="avatar" scale="0.5 0.5 0.5">
            <a-sphere class="head"
              color="#ffffff"
              scale="0.45 0.5 0.4"
            ></a-sphere>
            <a-entity class="face"
              position="0 0.05 0"
            >
              <a-sphere class="eye"
                color="#efefef"
                position="0.16 0.1 -0.35"
                scale="0.12 0.12 0.12"
              >
                <a-sphere class="pupil"
                  color="#000"
                  position="0 0 -1"
                  scale="0.2 0.2 0.2"
                ></a-sphere>
              </a-sphere>
              <a-sphere class="eye"
                color="#efefef"
                position="-0.16 0.1 -0.35"
                scale="0.12 0.12 0.12"
              >
                <a-sphere class="pupil"
                  color="#000"
                  position="0 0 -1"
                  scale="0.2 0.2 0.2"
                ></a-sphere>
              </a-sphere>
            </a-entity>
          </a-entity>
        </template>

        <!-- Hand -->
        <template id="hand-template">
          <a-entity>
            <a-box scale="0.1 0.1 0.1"></a-box>
          </a-entity>
        </template>

        <a-asset-item id="vive-controller-obj" src="https://cdn.aframe.io/controllers/vive/vr_controller_vive.obj"></a-asset-item>
        <a-asset-item id="vive-controller-mtl" src="https://cdn.aframe.io/controllers/vive/vr_controller_vive.mtl"></a-asset-item>

        <template id="avatar-template">
          <a-entity obj-model="obj: #vive-controller-obj; mtl: #vive-controller-mtl" scale="1 1 1"></a-entity>
        </template>

        <template id="right-controls-template">
          <a-entity class="right-controls">
            <a-entity obj-model="obj: #vive-controller-obj; mtl: #vive-controller-mtl" scale="1 1 1"></a-entity>
          </a-entity>
        </template>

        <template id="left-controls-template">
          <a-entity class="left-controls">
            <a-entity obj-model="obj: #vive-controller-obj; mtl: #vive-controller-mtl" scale="1 1 1"></a-entity>
          </a-entity>
        </template>

        <template id="projector-template">
          <a-entity class="projector" projector="Optoma ML750ST">
            <a-box position="-0.02 0 -0.06" scale="0.11 0.04 0.11" color="white"></a-box>
            <a-cylinder rotation="90 0 0" color="gray" height="0.02" radius="0.025"></a-cylinder>
          </a-entity>
        </template>

      <!-- /Templates -->
      </a-assets>

      <a-entity id="player" networked="template:#player-template;attachTemplateToLocal:false;" wasd-controls>
        <a-entity camera look-controls networked="template:#head-template;attachTemplateToLocal:false;">
            <a-sphere class="head"
              random-color
              visible="false"
            ></a-sphere>
        </a-entity>

        <a-entity vive-controls="hand: left" networked="template:#left-controls-template;attachTemplateToLocal:false;"></a-entity>
        <a-entity vive-controls="hand: right" spawn-projector="projectorTemplate:#projector-template" networked="template:#right-controls-template;attachTemplateToLocal:false;">
          <a-entity id="controller-adjustment" position="0.02 -0.06 -0.09" rotation="123 0 0">
            <a-entity id="projector-preview" projector="Optoma ML750ST">
              <a-box position="-0.02 0 -0.06" scale="0.11 0.04 0.11" color="white"></a-box>
              <a-cylinder rotation="90 0 0" color="gray" height="0.02" radius="0.025"></a-cylinder>
            </a-entity>
          </a-entity>
        </a-entity>
      </a-entity>

      <a-entity position="0 0 0"
        geometry="primitive: plane; width: 10000; height: 10000;" rotation="-90 0 0"
        material="src: #grid; repeat: 10000 10000; transparent: true; metalness:0.6; roughness: 0.4; sphericalEnvMap: #sky;"></a-entity>
﻿﻿﻿﻿
      <a-entity light="color: #ccccff; intensity: 1; type: ambient;" visible=""></a-entity>
      <a-entity light="color: #ffaaff; intensity: 1.5" position="5 5 5"></a-entity>

      <a-sky src="#sky" rotation="0 -90 0"></a-sky>
      <a-entity id="particles" particle-system="preset: snow"></a-entity>
    </a-scene>

    <div class="wizard content">
      <h1 class="title has-text-white">Use Vive Wand to Locate Projector</h1>
      <p><a class="has-text-primary" href="https://github.com/kfarr/aframe-matta">Follow setup instructions to get a projector mounted, run this page on the HTC Vive making this the "server".</a></p>
        <p>Place the right HTC Vive controller against the projector pointing down and press the trigger button. Use the VR headset to align the virtual projector to match the real life projector.</p>
        <p><a href="#" class="button is-primary">This button doesn't do anything yet.</a></p>
    </div>

    <script>
      // On mobile remove elements that are resource heavy
      var isMobile = AFRAME.utils.device.isMobile();
      if (isMobile) {
        var particles = document.getElementById('particles');
        particles.parentNode.removeChild(particles);
      }
    </script>

    <script>
      // Define custom schema for syncing avatar color, set by random-color
      NAF.schemas.add({
        template: '#head-template',
        components: [
          'position',
          'rotation',
          {
            selector: '.head',
            component: 'material'
          }
        ]
      });

      NAF.schemas.add({
        template: '#player-template',
        components: [
          'position',
          'rotation'
        ]
      });

      NAF.schemas.add({
        template: '#hand-template',
        components: [
          'position',
          'rotation'
        ]
      });

      // Called by Networked-Aframe when connected to server
      function onConnect () {
        console.log("onConnect");
      }
    </script>
  </body>
</html>
